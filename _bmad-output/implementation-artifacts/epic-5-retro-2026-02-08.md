# Epic 5 회고: 턴 관리 (Turn Management)

**프로젝트:** 오호대장군 (Five Tiger Generals)
**에픽:** Epic 5 - 턴 관리
**회고 날짜:** 2026-02-08
**Agent Model:** Claude Opus 4.6 (retrospective), Claude Opus 4.5 (implementation)

---

## 에픽 요약

### 전달 지표

| 항목 | 값 |
|------|-----|
| 완료된 스토리 | 4/4 (100%) |
| 테스트 증가 | 434개 → 480개+ (+46개+) |
| 신규 파일 | 12개 |
| 수정 파일 | 7개 |
| 차단 요소 | 0개 |
| 총 코드 변경 | +3,137줄 / -6줄 |

### 완료된 스토리

| # | 스토리 | 상태 | 주요 성과 |
|---|--------|------|----------|
| 5-1 | 턴 종료 버튼 (Turn End Button) | done | TurnEndButton UI, GameScene.executeEndTurn(), Space 키보드 단축키, GameHUD 레이아웃 |
| 5-2 | 현재 턴 표시 (Current Turn Display) | done | TurnIndicator UI, 플레이어별 색상 구분 (파랑/빨강), 턴 전환 펄스 애니메이션, 색맹 지원 |
| 5-3 | 60초 타이머 (Sixty Second Timer) | done | game-core 순수 타이머 로직 (timer.ts), TurnTimer UI, 경고/위험 단계 시각 피드백, 33개 타이머 테스트 |
| 5-4 | 타이머 자동 종료 (Timer Auto End) | done | handleTimerExpired(), isEndingTurn 동시 처리 방지, AutoEndToast 알림, turn:auto-end 이벤트 |

---

## 성공 및 강점

### 1. 아키텍처 경계 100% 준수 (5번째 연속 에픽)

- **game-core**: 타이머 로직(`timer.ts`)이 순수 TypeScript로 구현됨 - Phaser 의존성 없음
- **game-renderer**: 타이머 업데이트 루프(update/tick), 이벤트 발행 담당
- **apps/web**: React UI 컴포넌트(TurnEndButton, TurnIndicator, TurnTimer, AutoEndToast)
- 3계층 분리 패턴이 이제 프로젝트의 견고한 관행으로 정착됨

### 2. 함수형 불변 상태 관리 패턴 확립

```
createTurnTimerState() -> startTimer() -> tickTimer() -> resetTimer()
```

- 모든 타이머 함수가 순수 함수로 구현 (입력 -> 새 상태 반환)
- 불변성(immutability) 완벽 준수: spread operator로 새 객체 반환
- Phase 2 Colyseus 서버에서 동일 로직 재사용 가능 확보

### 3. 탄탄한 테스트 커버리지

- 타이머 단위 테스트 33개 작성 (timer.test.ts)
- GameScene.executeEndTurn 통합 테스트 작성 (GameScene.executeEndTurn.test.ts)
- 전체 테스트 480개+ 통과 (Epic 4 종료 시 434개 대비 +46개)
- 통합 시나리오 테스트: 전체 턴 사이클, 경고 -> 위험 -> 만료 전환 검증

### 4. React-Phaser 이벤트 브릿지 패턴 확립

- Phaser Scene 이벤트 -> React 상태 동기화 패턴이 명확하게 정립됨
- 이벤트 목록: `turn:start`, `turn:end`, `turn:auto-end`, `timer:tick`, `timer:expired`
- GameCanvas에서 이벤트 리스너 등록/해제 생명주기 관리 체계적
- gameSceneRef를 통한 React -> Phaser 명령(executeEndTurn) 호출 패턴

### 5. 점진적 기능 확장 (레이어드 개발)

- 5-1에서 턴 종료 기본 메커니즘 구축
- 5-2에서 턴 정보 시각화 추가
- 5-3에서 타이머 시스템을 기존 구조에 자연스럽게 통합
- 5-4에서 자동 종료/동시 처리 방지 추가
- 각 스토리가 이전 스토리의 코드를 확장하며 안정적으로 성장

### 6. 접근성(Accessibility) 고려

- TurnTimer: `role="timer"`, `aria-live="polite"`, `aria-label` 적용
- TurnIndicator: `role="status"`, `aria-live="polite"` 적용
- AutoEndToast: `role="alert"`, `aria-live="assertive"` 적용
- 색맹 지원: 이모지 아이콘 + 테두리 패턴으로 색상 외 구분 요소 추가
- 모바일 터치 타겟 44x44px 최소 크기 준수

### 7. 동시성 이슈 선제적 방지

- `isEndingTurn` 플래그로 타이머 만료와 수동 버튼 클릭 동시 처리 방지
- `try-finally` 패턴으로 플래그 해제 보장
- 애니메이션 진행 중 타이머 만료 시 `delayedCall`로 재시도 처리

---

## 도전 및 성장 영역

### 1. sprint-status.yaml 동기화 이슈

- **문제:** sprint-status.yaml에 Epic 4 상태가 아직 `in-progress`로 남아있고, 일부 스토리가 `ready-for-dev` 또는 `review` 상태로 실제와 불일치
- **원인:** 각 스토리 완료 시 sprint-status.yaml 업데이트가 일관되지 않음
- **영향:** 프로젝트 추적 정확성 저하
- **개선:** 스토리 완료 커밋 시 sprint-status.yaml 동시 업데이트를 필수 체크리스트에 포함

### 2. E2E 테스트 프레임워크 여전히 미도입 (Epic 1부터 이연)

- **문제:** Playwright/Cypress E2E 테스트가 4번째 에픽 연속 미도입
- **원인:** 기능 개발 우선순위가 높아 테스트 인프라 투자 후순위
- **영향:** 턴 관리 전체 플로우(버튼 클릭 -> 턴 전환 -> 타이머 리셋 -> 자동 종료)를 수동 테스트에 의존
- **위험:** 회귀 테스트 누락 가능성 증가

### 3. GameScene 클래스 비대화

- **문제:** GameScene.ts가 1,555줄로 성장 - 디버그 함수만 500줄+ 차지
- **원인:** 각 에픽마다 로직이 추가되면서 단일 파일에 집중됨
- **영향:** 가독성/유지보수성 저하
- **개선 방향:**
  - 디버그 함수를 별도 모듈(`DebugCommands.ts`)로 분리
  - 전투 로직을 `CombatHandler.ts`로 분리
  - 타이머 관리를 `TimerManager.ts`로 분리
  - Composition 패턴 적용 검토

### 4. CSS 파일 산재

- **문제:** TurnEndButton.css, TurnIndicator.css, TurnTimer.css, AutoEndToast.css 등 개별 CSS 파일 다수 생성
- **원인:** 컴포넌트별 CSS 파일 분리 패턴 사용
- **영향:** CSS 이름 충돌 가능성 (BEM 네이밍으로 부분 완화), 스타일 일관성 관리 어려움
- **개선 방향:** CSS Modules 또는 TailwindCSS 일괄 적용 검토

### 5. 로컬 2인 플레이 모드의 "내 턴" 개념 단순화

- **문제:** `isMyTurn`이 항상 `true`로 하드코딩 (로컬 모드)
- **영향:** Phase 2 온라인 모드 전환 시 상당한 리팩토링 필요
- **대비:** 현재 인터페이스(props)는 확장 가능하게 설계됨. Phase 2에서 `isMyTurn` 로직만 교체하면 됨

---

## 핵심 인사이트

1. **이벤트 기반 아키텍처의 확장성** - Phaser Scene 이벤트를 중심으로 React UI, 타이머, 자동 종료 등 다양한 기능이 느슨하게 결합됨. 새 기능 추가 시 기존 코드 수정 최소화 가능
2. **순수 함수의 테스트 용이성** - timer.ts의 모든 함수가 순수 함수여서 33개 테스트를 빠르게 작성 가능. 상태 조합 검증이 단순명료
3. **점진적 레이어드 개발의 효과** - 5-1 -> 5-2 -> 5-3 -> 5-4 순서로 각 스토리가 이전 인프라 위에 자연스럽게 구축됨
4. **동시성은 선제적으로 방지** - `isEndingTurn` 플래그 + `try-finally` 패턴으로 경쟁 조건(race condition) 사전 차단
5. **GameScene 분리 시점 도래** - 1,500줄 이상의 단일 파일은 리팩토링 신호. Epic 6 시작 전 분리 검토 필요

---

## 기술 부채

| # | 항목 | 우선순위 | 출처 | 비고 |
|---|------|---------|------|------|
| 1 | Playwright E2E 테스트 미도입 | HIGH | Epic 1-5 | 5번째 에픽 연속 이연. Epic 6 완료 전 필수 도입 |
| 2 | GameScene.ts 분리 (1,555줄) | HIGH | Epic 5 | 디버그/전투/타이머 로직 분리 필요 |
| 3 | sprint-status.yaml 동기화 | MEDIUM | Epic 5 | 실제 상태와 불일치. 일괄 업데이트 필요 |
| 4 | CSS 스타일 관리 체계화 | MEDIUM | Epic 5 | CSS Modules 또는 TailwindCSS 적용 검토 |
| 5 | Triangle 객체 풀링 | MEDIUM | Epic 3 | 아직 미해결 |
| 6 | TILE_META 조회 최적화 | MEDIUM | Epic 3 | 아직 미해결 |
| 7 | 사운드 에셋 placeholder 교체 | LOW | Epic 4 | 최종 에셋으로 교체 필요 |

---

## Epic 4 회고 액션 아이템 추적

| # | 액션 아이템 | 담당 | 상태 | 비고 |
|---|------------|------|------|------|
| 1 | 타이머 UI 컴포넌트 설계 | - | done | Story 5-3에서 TurnTimer 구현 |
| 2 | 턴 전환 로직 명세 | - | done | Story 5-1에서 executeEndTurn 구현 |
| 3 | E2E 테스트 도입 검토 | - | pending | 아직 미도입 |

**Epic 4 팀 합의 준수 여부:**
- game-core Phaser 금지: 완전 준수 (4/4 스토리)
- 새 상수/타입 game-core 정의: 준수 (TIMER_WARNING_THRESHOLD, TIMER_CRITICAL_THRESHOLD, TurnTimerState)
- Dev Notes 기록: 준수 (4개 스토리 모두)
- Result<T> 패턴: 해당 없음 (턴 관리는 void 반환 패턴 사용)

---

## 액션 아이템

### 프로세스 개선

| # | 액션 아이템 | 담당 | 마감 | 성공 기준 |
|---|------------|------|------|----------|
| 1 | GameScene.ts 리팩토링 (모듈 분리) | Dev | Epic 6 시작 전 | 디버그/전투/타이머 별도 파일 분리, GameScene 800줄 이하 |
| 2 | E2E 테스트 프레임워크 도입 | QA | Epic 6 완료 전 | 턴 관리 + 전투 E2E 테스트 1개 이상 |
| 3 | sprint-status.yaml 일괄 정리 | SM | 즉시 | Epic 4 done, Epic 5 done, 모든 스토리 상태 정확 |
| 4 | CSS 관리 방안 결정 | Dev | Epic 7 시작 전 | CSS Modules / TailwindCSS 중 선택 |

### 팀 합의 (계속 유지)

- [x] game-core에 Phaser 의존성 절대 금지
- [x] 새 상수/타입은 game-core에 먼저 정의
- [x] 스토리 완료 시 Dev Notes에 학습 내용 기록
- [x] 코드 리뷰에서 아키텍처 경계 확인
- [x] Public getter로 데이터 노출 (private 접근 금지)
- [x] 게임 루프 내 new 사용 금지 (객체 재사용)

### 새로운 팀 합의

- [x] 스토리 완료 커밋 시 sprint-status.yaml 동시 업데이트 필수
- [x] ARIA 속성 (role, aria-live, aria-label) 모든 UI 컴포넌트에 적용
- [x] 단일 파일 1,000줄 초과 시 분리 검토 필수

---

## 기술적 성과 하이라이트

### 새로운 패턴/시스템

| 패턴 | 설명 | 파일 |
|------|------|------|
| 순수 함수형 타이머 | 불변 상태 관리 (create/start/tick/reset/pause/resume) | game-core/src/turn/timer.ts |
| React-Phaser 이벤트 브릿지 | Phaser Scene 이벤트 -> React useState 동기화 | apps/web/src/components/game/GameCanvas.tsx |
| 키보드 단축키 훅 | Space 키 턴 종료, 입력 필드 포커스 시 무시 | apps/web/src/hooks/useKeyboardShortcuts.ts |
| 동시 처리 방지 패턴 | isEndingTurn + try-finally로 경쟁 조건 방지 | game-renderer/src/scenes/GameScene.ts |
| 자동 종료 알림 | Toast 패턴 (fade in/out, 3초 자동 숨김) | apps/web/src/components/game/AutoEndToast.tsx |
| GameHUD 레이아웃 | 상단 중앙(턴 정보) + 하단 우측(버튼) 오버레이 | apps/web/src/components/game/GameHUD.tsx |

### 이벤트 시스템 확장

| 이벤트 | 페이로드 | 용도 | 스토리 |
|--------|----------|------|--------|
| turn:end | { turn, playerId } | 턴 종료 시 | 5-1 |
| turn:start | { turn, playerId } | 턴 시작 시 | 5-1 |
| timer:tick | { remainingTime } | 매초 타이머 업데이트 | 5-3 |
| timer:expired | {} | 타이머 0초 도달 | 5-3 |
| turn:auto-end | { playerId, turn } | 타이머 만료 자동 종료 | 5-4 |

### 타입 확장

| 타입 | 설명 | 파일 |
|------|------|------|
| TurnTimerState | { remainingTime, isRunning } | game-core/src/turn/timer.ts |
| TurnState | { currentPlayer, turn, isGameEnded, remainingTime } | apps/web GameCanvas 내부 인터페이스 |
| AutoEndToastProps | { isVisible, onHide } | apps/web AutoEndToast 컴포넌트 |
| TurnTimerProps | { remainingTime } | apps/web TurnTimer 컴포넌트 |
| TurnIndicatorProps | { currentPlayer, turn, remainingTime? } | apps/web TurnIndicator 컴포넌트 |

### 상수 추가

| 상수 | 값 | 파일 |
|------|-----|------|
| TIMER_WARNING_THRESHOLD | 30 | game-core/src/constants/game.ts |
| TIMER_CRITICAL_THRESHOLD | 10 | game-core/src/constants/game.ts |

---

## 중요 발견 사항

**에픽 업데이트 필요:** 아니오

Epic 5에서 Epic 6 계획을 변경해야 할 발견은 없었습니다.
- 턴 관리 시스템이 GDD 명세대로 구현됨
- 이벤트 기반 아키텍처가 안정적으로 확장 가능
- 승리 조건(Epic 6) 구현에 필요한 기반이 모두 준비됨 (턴 전환, 상태 관리, 이벤트 시스템)

---

## 준비 상태 평가

| 항목 | 상태 | 비고 |
|------|------|------|
| 테스트 & 품질 | done | 480개+ 단위/통합 테스트 통과 |
| 빌드 | done | pnpm build 성공 |
| 타입 체크 | done | pnpm typecheck 성공 |
| 기술 건강 | done | 아키텍처 경계 100% 준수, 동시성 방지 패턴 적용 |
| 미해결 차단요소 | done | 없음 |
| GameScene 비대화 | warning | 1,555줄 - Epic 6 전 분리 권장 |

---

## 다음 단계

1. **sprint-status.yaml 업데이트** (Epic 5 -> done, retrospective -> done)
2. **GameScene.ts 리팩토링** (HIGH 우선순위 기술 부채)
3. **Epic 6: 승리 조건 시작** (`create-story` 워크플로우 사용)
   - 6-1: 노크 행동 (Knock Action)
   - 6-2: 3회 노크 승리 (Triple Knock Victory)
   - 6-3: 전멸 승리 (Annihilation Victory)
   - 6-4: 와해 승리 (Collapse Victory)
   - 6-5: 항복 (Surrender)
4. **E2E 테스트 도입** (HIGH 우선순위, 더 이상 이연 불가)

---

## Epic 6 의존성 확인

| 의존성 | 상태 | 비고 |
|--------|------|------|
| 턴 전환 시스템 | done | endTurn(), executeEndTurn() |
| 타이머 시스템 | done | 60초 카운트다운, 자동 종료 |
| 전투 시스템 | done | 공격, 데미지, OUT 처리 |
| 이벤트 시스템 | done | turn:start/end, timer:*, general:out |
| 게임 상태 관리 | done | GameState, currentPlayer, phase |
| UI 프레임워크 | done | GameHUD, 토스트 알림, 이벤트 브릿지 |

**결론:** Epic 6 시작을 위한 모든 의존성 충족됨.

---

## 문서 정보

- **생성일:** 2026-02-08
- **다음 회고:** Epic 6 완료 후
- **Sprint Status 키:** epic-5-retrospective -> done
