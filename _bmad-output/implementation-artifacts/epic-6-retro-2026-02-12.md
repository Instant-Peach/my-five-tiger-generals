# Epic 6 회고: 승리 조건 (Victory Conditions)

**프로젝트:** 오호대장군 (Five Tiger Generals)
**에픽:** Epic 6 - 승리 조건
**회고 날짜:** 2026-02-12
**Agent Model:** Claude Opus 4.6 (retrospective & implementation)

---

## 에픽 요약

### 전달 지표

| 항목 | 값 |
|------|-----|
| 완료된 스토리 | 5/5 (100%) |
| 테스트 증가 | 480개 → 561개 (+81개) |
| 신규 파일 | 15개 |
| 수정 파일 | 14개 |
| 차단 요소 | 0개 |
| correct-course 발생 | 1건 (Story 6-2) |
| 총 코드 변경 | +2,460줄 / -19줄 |

### 완료된 스토리

| # | 스토리 | 상태 | 주요 성과 |
|---|--------|------|----------|
| 6-1 | 노크 행동 (Knock Action) | done | canKnock/executeKnock() 순수 함수, KnockButton UI, knock:success 이벤트, 40개 테스트 |
| 6-2 | 3회 노크 승리 (Triple Knock Victory) | done | checkKnockVictory(), VictoryBanner UI, game:end 이벤트, correct-course로 리셋 로직 제거 |
| 6-3 | 전멸 승리 (Annihilation Victory) | done | checkAnnihilationVictory(), executeAttack() 승리 판정 통합, ExecuteAttackData 확장 |
| 6-4 | 와해 승리 (Collapse Victory) | done | checkCollapseVictory()로 annihilation 대체, executeKnock() 와해 판정 추가, 테스트 마이그레이션 |
| 6-5 | 항복 (Surrender) | done | executeSurrender(), SurrenderButton/SurrenderConfirmModal UI, 확인 모달 패턴 |

---

## 성공 및 강점

### 1. 아키텍처 경계 100% 준수 (6번째 연속 에픽)

- **game-core**: victory 모듈(knock.ts, collapse.ts, surrender.ts) 전부 순수 TypeScript로 구현 - Phaser 의존성 없음
- **game-renderer**: GameScene에서 game-core 함수 호출 후 이벤트 발행만 담당
- **apps/web**: React UI 컴포넌트(KnockButton, VictoryBanner, SurrenderButton, SurrenderConfirmModal)
- 3계층 분리 패턴이 6개 에픽 연속 100% 준수

### 2. victory 모듈 체계적 설계

```
packages/game-core/src/victory/
├── index.ts       # 모듈 export 허브
├── knock.ts       # 노크 로직 (canKnock, executeKnock, checkKnockVictory)
├── collapse.ts    # 와해 승리 판정 (checkCollapseVictory)
└── surrender.ts   # 항복 실행 (executeSurrender)
```

- 승리 조건별 파일 분리로 단일 책임 원칙 준수
- 모든 함수가 순수 함수 (입력 -> 새 상태 반환)
- 공통 타입(VictoryResult, VictoryReason)을 state/types.ts에 정의하여 일관성 유지
- Phase 2 서버에서 동일 로직 재사용 가능

### 3. 일관된 승리 판정 패턴

```typescript
// 모든 승리 조건이 동일한 패턴 사용
checkKnockVictory(state) → VictoryResult | null
checkCollapseVictory(state) → VictoryResult | null
executeSurrender(state, playerId) → Result<ExecuteSurrenderData>
```

- VictoryResult 단일 타입으로 모든 승리 조건 통합: { winner: PlayerId, reason: VictoryReason }
- GameScene에서 'game:end' 이벤트 발행 패턴 통일
- VictoryBanner 컴포넌트가 reason별 텍스트 매핑으로 모든 승리 조건 지원

### 4. correct-course를 통한 기획 오류 조기 수정

- Story 6-2 개발 중 노크 카운트 리셋 메커니즘이 게임 규칙과 불일치 발견
- GDD 재검토 결과 "노크 카운트는 게임 전체 누적값" 확인
- AC2(이동 리셋), AC3(전투 리셋), AC5(리셋 이벤트) 삭제로 범위 축소
- 불필요한 복잡도 제거로 코드 품질 향상

### 5. 탄탄한 테스트 커버리지

- 전체 테스트 561개 통과 (Epic 5 종료 시 480개 대비 +81개)
- 스토리별 테스트 분포:
  - knock.test.ts: 53개 (canKnock, validateKnock, executeKnock, checkKnockVictory)
  - collapse.test.ts: 10개 (checkCollapseVictory)
  - knock-collapse.test.ts: 4개 (노크에서의 와해 승리 엣지 케이스)
  - attack-collapse.test.ts: 7개 (공격 후 와해 승리 통합)
  - surrender.test.ts: 7개 (executeSurrender)
- 기존 테스트 파일 5개 수정 (GameState knockCount 필드 추가 반영)

### 6. 승리 조건 간 우선순위 처리

- 노크 승리 > 와해 승리 우선순위 정립
- executeKnock() 내부에서 checkKnockVictory() 먼저 실행, 미달 시 checkCollapseVictory() 실행
- 엣지 케이스(노크로 마지막 장수 OUT, 노크 3회 + 동시 와해) 테스트 커버리지 확보

### 7. React UI 컴포넌트 패턴 성숙

- KnockButton: 노크 카운트 시각화 (원형 인디케이터), 접근성 속성
- VictoryBanner: 오버레이 + 중앙 배너, reason별 텍스트/색상 분기
- SurrenderButton + SurrenderConfirmModal: 확인 모달 패턴으로 오조작 방지
- 모든 UI 컴포넌트에 ARIA 속성 적용 (role, aria-label, aria-modal)

---

## 도전 및 성장 영역

### 1. Story 6-2 기획 오류 (correct-course 발생)

- **문제:** 초기 Story 6-2에 노크 카운트 리셋 메커니즘이 포함됨 (AC2: 이동으로 구역 이탈 시 리셋, AC3: 전투 OUT 시 리셋)
- **원인:** GDD의 "노크 중 밀려나면 카운트 리셋" 문구를 잘못 해석
- **해결:** correct-course 워크플로우로 AC2, AC3, AC5 삭제. 노크 카운트는 게임 전체 누적값으로 확정
- **학습:** 기획 문서의 모호한 표현은 구현 전에 반드시 확인. "correct-course" 패턴이 효과적

### 2. GameScene 비대화 지속 (1,708줄)

- **문제:** GameScene.ts가 Epic 5 종료 시 1,555줄에서 1,708줄로 +153줄 증가
- **원인:** handleKnock(), handleSurrender(), 승리 판정 로직 추가
- **영향:** 가독성/유지보수성 저하 지속
- **완화:** 승리 판정 로직 대부분을 game-core에 위임하여 GameScene 코드 최소화 노력
- **개선 방향:** Epic 7 시작 전 GameScene 리팩토링 필수 (KnockHandler, VictoryHandler 분리 등)

### 3. Story 6-3/6-4 전멸/와해 용어 혼동

- **문제:** Story 6-3에서 checkAnnihilationVictory()를 구현했으나, 실제 로직은 "모든 장수 OUT 체크" = 와해(collapse) 판정
- **원인:** 게임 규칙의 전멸(개별 장수 병력 0)과 와해(모든 장수 OUT)가 Phase 1에서 동일 동작이므로 혼동
- **해결:** Story 6-4에서 annihilation.ts를 삭제하고 collapse.ts로 완전 대체, 테스트 마이그레이션 수행
- **학습:** 도메인 용어를 정확하게 사용해야 향후 Phase 확장 시 혼란 방지

### 4. E2E 테스트 프레임워크 6번째 에픽 연속 미도입

- **문제:** Playwright/Cypress E2E 테스트가 여전히 미도입
- **영향:** 노크 → 승리 판정 → VictoryBanner 표시 전체 플로우를 수동 테스트에 의존
- **위험:** 회귀 테스트 누락 가능성 지속 증가

### 5. CSS 파일 산재 지속

- **문제:** KnockButton.css, VictoryBanner.css, SurrenderButton.css, SurrenderConfirmModal.css 등 4개 CSS 파일 추가
- **영향:** 전체 CSS 파일 10개+ 이상으로 증가, 스타일 일관성 관리 어려움
- **개선 방향:** CSS Modules 또는 TailwindCSS 일괄 적용 검토 (Epic 5 회고에서도 동일 지적)

---

## 핵심 인사이트

1. **승리 조건 모듈 분리의 확장성** - victory/ 디렉토리에 승리 조건별 파일을 분리하여 향후 새로운 승리 조건(시간 초과 승리 등) 추가가 용이한 구조 확보
2. **correct-course의 가치** - 기획 오류를 개발 초기에 발견하고 수정하는 것이 나중에 수정하는 것보다 비용이 월등히 낮음. Story 6-2에서 3개 AC 삭제로 불필요한 복잡도 회피
3. **도메인 용어의 정확한 사용** - 전멸(annihilation)과 와해(collapse)의 혼동이 Story 6-3에서 발생한 후 6-4에서 수정. 도메인 용어는 구현 전에 명확히 정의해야 함
4. **VictoryResult 단일 타입의 위력** - 하나의 타입으로 4가지 승리 조건(knock, collapse, surrender + 향후 annihilation)을 통합. 새 승리 조건 추가 시 VictoryReason 유니온만 확장
5. **확인 모달 패턴의 필요성** - 항복처럼 되돌릴 수 없는 행동에는 확인 모달이 필수. SurrenderConfirmModal 패턴은 향후 다른 위험 행동에도 재사용 가능

---

## 기술 부채

| # | 항목 | 우선순위 | 출처 | 비고 |
|---|------|---------|------|------|
| 1 | Playwright E2E 테스트 미도입 | HIGH | Epic 1-6 | 6번째 에픽 연속 이연. Phase 1 완료 전 필수 도입 |
| 2 | GameScene.ts 분리 (1,708줄) | HIGH | Epic 5-6 | 디버그/전투/타이머/노크/승리 로직 분리 필요 |
| 3 | CSS 스타일 관리 체계화 | MEDIUM | Epic 5-6 | CSS Modules 또는 TailwindCSS 적용 검토. CSS 파일 10개+ |
| 4 | sprint-status.yaml 동기화 | MEDIUM | Epic 5-6 | Story 6-5 커밋 시 일괄 업데이트 필요 |
| 5 | Triangle 객체 풀링 | MEDIUM | Epic 3 | 아직 미해결 |
| 6 | TILE_META 조회 최적화 | MEDIUM | Epic 3 | 아직 미해결 |
| 7 | 사운드 에셋 placeholder 교체 | LOW | Epic 4 | 최종 에셋으로 교체 필요 |
| 8 | VictoryReason 'annihilation' 미사용 | LOW | Epic 6 | Phase 1에서 미사용, 향후 패전 복귀 구현 시 활용 예정 |

---

## Epic 5 회고 액션 아이템 추적

| # | 액션 아이템 | 담당 | 상태 | 비고 |
|---|------------|------|------|------|
| 1 | GameScene.ts 리팩토링 (모듈 분리) | Dev | pending | 1,555줄 → 1,708줄로 오히려 증가. Epic 7 전 필수 |
| 2 | E2E 테스트 프레임워크 도입 | QA | pending | 여전히 미도입. Phase 1 완료 전 필수 |
| 3 | sprint-status.yaml 일괄 정리 | SM | partial | Epic 6 스토리 상태 부분 업데이트됨 |
| 4 | CSS 관리 방안 결정 | Dev | pending | 결정 미완료. CSS 파일 4개 추가됨 |

**Epic 5 팀 합의 준수 여부:**
- game-core Phaser 금지: 완전 준수 (5/5 스토리)
- 새 상수/타입 game-core 정의: 준수 (VictoryResult, VictoryReason, knockCount 등)
- Dev Notes 기록: 준수 (5개 스토리 모두)
- 스토리 완료 커밋 시 sprint-status.yaml 동시 업데이트: 부분 준수
- ARIA 속성 적용: 준수 (KnockButton, VictoryBanner, SurrenderButton, SurrenderConfirmModal 모두)
- 단일 파일 1,000줄 초과 시 분리 검토: 미준수 (GameScene 1,708줄 유지)

---

## 액션 아이템

### 프로세스 개선

| # | 액션 아이템 | 담당 | 마감 | 성공 기준 |
|---|------------|------|------|----------|
| 1 | GameScene.ts 리팩토링 (모듈 분리) | Dev | Epic 7 시작 전 | KnockHandler, VictoryHandler, CombatHandler, TimerManager 분리. GameScene 900줄 이하 |
| 2 | E2E 테스트 프레임워크 도입 | QA | Phase 1 완료 전 | 노크 승리 + 항복 E2E 테스트 1개 이상 |
| 3 | CSS 관리 방안 결정 및 적용 | Dev | Epic 8 시작 전 | CSS Modules / TailwindCSS 중 선택 후 기존 CSS 마이그레이션 |
| 4 | sprint-status.yaml 일괄 정리 | SM | 즉시 | Epic 6 done, 모든 스토리 done, retrospective done |
| 5 | 기획 모호성 사전 검증 프로세스 | SM/PO | Epic 7 시작 시 | 스토리 생성 전 GDD 용어/규칙 명확화 체크리스트 추가 |

### 팀 합의 (계속 유지)

- [x] game-core에 Phaser 의존성 절대 금지
- [x] 새 상수/타입은 game-core에 먼저 정의
- [x] 스토리 완료 시 Dev Notes에 학습 내용 기록
- [x] 코드 리뷰에서 아키텍처 경계 확인
- [x] Public getter로 데이터 노출 (private 접근 금지)
- [x] 게임 루프 내 new 사용 금지 (객체 재사용)
- [x] 스토리 완료 커밋 시 sprint-status.yaml 동시 업데이트 필수
- [x] ARIA 속성 (role, aria-live, aria-label) 모든 UI 컴포넌트에 적용
- [x] 단일 파일 1,000줄 초과 시 분리 검토 필수

### 새로운 팀 합의

- [x] 기획 문서의 모호한 표현은 구현 전 PO와 확인 (correct-course 방지)
- [x] 도메인 용어는 게임 규칙 문서의 정의를 정확히 따름 (전멸 vs 와해 등)
- [x] 되돌릴 수 없는 사용자 행동에는 확인 모달 필수 (항복, 향후 게임 포기 등)

---

## 기술적 성과 하이라이트

### 새로운 패턴/시스템

| 패턴 | 설명 | 파일 |
|------|------|------|
| victory 모듈 구조 | 승리 조건별 파일 분리 (knock, collapse, surrender) | game-core/src/victory/ |
| VictoryResult 통합 타입 | 모든 승리 조건을 단일 타입으로 표현 | game-core/src/state/types.ts |
| 노크 유효성 3단계 | canKnock() → validateKnock() → executeKnock() | game-core/src/victory/knock.ts |
| 승리 판정 체인 | executeKnock() 내 knock → collapse 순차 판정 | game-core/src/victory/knock.ts |
| VictoryBanner 오버레이 | reason별 텍스트/색상 분기, 페이드인 애니메이션 | apps/web/src/components/game/VictoryBanner.tsx |
| 확인 모달 패턴 | SurrenderConfirmModal: 오버레이 + 확인/취소 | apps/web/src/components/game/SurrenderConfirmModal.tsx |
| 노크 카운트 시각화 | 원형 인디케이터 (빈 원/채워진 원) 3단계 표시 | apps/web/src/components/game/KnockButton.tsx |

### 이벤트 시스템 확장

| 이벤트 | 페이로드 | 용도 | 스토리 |
|--------|----------|------|--------|
| knock:success | { playerId, generalId, knockCount, tileId } | 노크 성공 시 | 6-1 |
| knock:availability | { knockAvailable } | 노크 가능 여부 전달 | 6-1 |
| game:end | { winner, reason } | 게임 종료 (모든 승리 조건) | 6-2 |

### 타입 확장

| 타입 | 설명 | 파일 |
|------|------|------|
| VictoryReason | 'knock' \| 'annihilation' \| 'collapse' \| 'surrender' | game-core/src/state/types.ts |
| VictoryResult | { winner: PlayerId; reason: VictoryReason } | game-core/src/state/types.ts |
| ExecuteKnockData | { state, knockCount, playerId, victoryResult } | game-core/src/victory/knock.ts |
| ExecuteSurrenderData | { state, victoryResult } | game-core/src/victory/surrender.ts |
| GameState 확장 | player1KnockCount, player2KnockCount, victoryResult? | game-core/src/state/types.ts |

### 상수 활용

| 상수 | 값 | 파일 | 용도 |
|------|-----|------|------|
| GAME.KNOCK_COUNT_TO_WIN | 3 | game-core/src/constants/game.ts | 노크 승리 기준 (기존 정의 활용) |

---

## 중요 발견 사항

**에픽 업데이트 필요:** 아니오

Epic 6에서 Epic 7 이후 계획을 변경해야 할 발견은 없었습니다.
- 승리 조건 시스템이 GDD 명세대로 구현됨
- VictoryResult/VictoryReason 타입이 확장 가능하게 설계됨
- 향후 책략(Epic 7)이나 UI/UX(Epic 8)에서 추가 승리 조건이 필요할 경우 victory 모듈에 파일 추가만으로 대응 가능
- Phase 1 MVP의 핵심 게임 루프(보드 → 장수 → 이동 → 전투 → 턴 → 승리)가 완성됨

---

## 준비 상태 평가

| 항목 | 상태 | 비고 |
|------|------|------|
| 테스트 & 품질 | done | 561개 단위/통합 테스트 통과 |
| 빌드 | done | pnpm build 성공 |
| 타입 체크 | done | pnpm typecheck 성공 |
| 기술 건강 | done | 아키텍처 경계 100% 준수, 승리 조건 4종 구현 |
| 미해결 차단요소 | done | 없음 |
| GameScene 비대화 | warning | 1,708줄 - Epic 7 전 분리 필수 |
| E2E 테스트 부재 | warning | Phase 1 완료 전 도입 필수 |

---

## 다음 단계

1. **sprint-status.yaml 업데이트** (Epic 6 -> done, retrospective -> done)
2. **GameScene.ts 리팩토링** (HIGH 우선순위 기술 부채, 1,708줄 → 900줄 목표)
3. **Epic 7: 책략 시스템 시작** (`create-story` 워크플로우 사용)
   - 7-1: 책략 선택 메뉴 (Tactic Selection Menu)
   - 7-2: 강타 (Tactic Strike)
   - 7-3: 돌파 (Tactic Breakthrough)
   - ... (총 10개 스토리)
4. **E2E 테스트 도입** (HIGH 우선순위, 6번째 에픽 연속 이연)

---

## Epic 7 의존성 확인

| 의존성 | 상태 | 비고 |
|--------|------|------|
| 턴 전환 시스템 | done | endTurn(), executeEndTurn() |
| 전투 시스템 | done | 공격, 데미지, OUT 처리 |
| 이동 시스템 | done | moveGeneral(), 행동 시스템 |
| 행동 제한 시스템 | done | ActionType('tactic' 이미 정의), actionsRemaining |
| 이벤트 시스템 | done | turn:*, general:*, knock:*, game:end |
| 게임 상태 관리 | done | GameState, phase, victoryResult |
| UI 프레임워크 | done | GameHUD, VictoryBanner, 이벤트 브릿지 |
| 승리 조건 시스템 | done | 4종 승리 판정 + VictoryBanner |

**결론:** Epic 7 시작을 위한 모든 의존성 충족됨.

---

## 문서 정보

- **생성일:** 2026-02-12
- **다음 회고:** Epic 7 완료 후
- **Sprint Status 키:** epic-6-retrospective -> done
