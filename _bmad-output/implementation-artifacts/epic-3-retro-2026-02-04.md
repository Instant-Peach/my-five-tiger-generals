# 에픽 3 회고: 이동 시스템 (Movement System)

**프로젝트:** 오호대장군 (Five Tiger Generals)
**에픽:** Epic 3 - 이동 시스템
**회고 날짜:** 2026-02-04
**진행자:** Bob (Scrum Master)

---

## 에픽 요약

### 전달 지표

| 항목 | 값 |
|------|-----|
| 완료된 스토리 | 5/5 (100%) |
| 테스트 증가 | 261 → 352개 (+91개) |
| 신규 파일 | 5개+ |
| 수정 파일 | 15개+ |
| 차단 요소 | 0개 |
| 기술 부채 | 5개 항목 |

### 완료된 스토리

| # | 스토리 | 상태 | 주요 성과 |
|---|--------|------|----------|
| 3-1 | 이동 가능 타일 표시 | done | getMovableTilesForGeneral(), BFS 이동 범위 계산, 변 인접 vs 꼭짓점 인접 분리 |
| 3-2 | 장수 이동 | review | moveGeneral(), 행동 제한 시스템, ActionType/PerformedAction 타입 |
| 3-3 | 장수 이동 애니메이션 | review | animateMoveTo(), 애니메이션 상태 관리, 입력 차단 |
| 3-4 | 경로 차단 | review | 경로 차단 로직 (3-1에서 이미 구현됨), blocked 파라미터 활용 |
| 3-5 | 경로 미리보기 | review | findPath() BFS 경로 탐색, 경로 미리보기 UI, 모바일 롱프레스 |

---

## 팀 참석자

| 이름 | 역할 |
|------|------|
| Bob (Max) | Scrum Master (진행자) |
| Alice (Samus Shepard) | Product Owner / Game Designer |
| Charlie (Cloud Dragonborn) | Senior Dev / Game Architect |
| Dana (GLaDOS) | QA Engineer |
| Elena (Indie) | Junior Dev |
| CHOI | Project Lead |

---

## 성공 및 강점

### 1. 아키텍처 경계 100% 준수
- game-core: Phaser 의존성 없이 순수 TypeScript 로직 유지 (5/5 스토리)
- game-renderer: 렌더링/애니메이션 전용 로직 분리
- 이동 로직(game-core)과 애니메이션(game-renderer) 완벽 분리
- Phase 2 Colyseus 서버 재사용 기반 확실히 유지

### 2. 점진적 테스트 확장
- Epic 시작: 261개 → Epic 완료: 352개 (+91개 테스트)
- 스토리별 테스트 증가:
  - 3-1: +25개 (286개)
  - 3-2: +40개 (326개)
  - 3-3: +22개 (348개)
  - 3-4: 기존 테스트 활용 (326개)
  - 3-5: +4개 (352개)
- Red-Green-Refactor TDD 사이클 모든 스토리에서 적용

### 3. 코드 리뷰 문화 지속
- Story 3-5 코드 리뷰에서 10개 이슈 발견
  - 4 High, 4 Medium, 2 Low
  - HIGH 3개 즉시 수정 (BoardRenderer getter 추가, @ts-expect-error 제거, destroy() 추가)
  - MEDIUM/LOW는 기술 부채로 기록
- BoardRenderer public API 개선으로 캡슐화 강화

### 4. BFS 알고리즘 통합
- 이동 범위 계산: `getReachableTiles()` - BFS 기반
- 경로 탐색: `findPath()` - BFS 기반 최단 경로
- 인접 타일 계산: `EDGE_ADJACENCY_MAP`, `getAdjacentTiles()`
- 47개+ 경로 탐색 테스트로 안정성 확보

### 5. 타입 안전 에러 처리 지속
- Result<T> 패턴 이동 액션에도 적용
- moveGeneral() 함수 모든 실패 케이스 타입화
- GameErrorCode 확장 (INVALID_MOVE, OUT_OF_RANGE, ALREADY_PERFORMED_ACTION)

### 6. 입력 시스템 확장
- 데스크톱: 호버 기반 경로 미리보기
- 모바일: 롱프레스(500ms) 기반 경로 미리보기
- 애니메이션 중 입력 차단으로 상태 일관성 보장

---

## 도전 및 성장 영역

### 1. 타일 인접 관계 혼동
- **문제:** Story 3-1에서 변 인접과 꼭짓점 인접이 혼동됨
- **원인:** 이동(변 인접)과 다른 로직(꼭짓점 인접)이 다른 규칙 적용
- **해결:** EDGE_ADJACENCY_MAP과 VERTEX_ADJACENCY_MAP 분리
- **학습:** 도메인 규칙을 먼저 명확히 정의하고 구현 시작

### 2. 측면 타일(30-33) 인접 관계
- **문제:** 측면 타일의 인접 관계가 메인 타일과 다름
- **원인:** 측면 타일은 좌/우 방향, 메인 타일은 상/하 방향
- **해결:** 타일 타입별 인접 관계 수동 정의
- **학습:** 특수 케이스는 테스트로 먼저 검증

### 3. game-renderer 테스트 인프라 부재
- **문제:** Story 3-3에서 애니메이션 테스트 필요했으나 설정 없음
- **원인:** game-renderer가 Phaser 의존으로 단위 테스트 어려움
- **해결:** vitest 설정 추가, Phaser 모킹으로 테스트 가능하게 구성
- **학습:** 테스트 인프라는 초기에 설정해야 함

### 4. E2E 테스트 여전히 부재
- **문제:** Epic 1, 2에서 약속한 Playwright 도입 미완료
- **영향:** 회귀 테스트 커버리지 부족, 수동 테스트 의존
- **계획:** Epic 4 완료 전 반드시 도입

### 5. @ts-expect-error 사용
- **문제:** GameScene에서 BoardRenderer의 private 멤버 직접 접근
- **원인:** 공개 API 부재로 타입 시스템 우회
- **해결:** public getter 메서드 추가 (getTileConfig, getTileScale, getOffsets)
- **학습:** 필요한 데이터는 명시적 API로 노출

---

## 핵심 인사이트

1. **도메인 규칙 선(先) 정의** - 인접 관계 혼동은 규칙 불명확에서 기인
2. **테스트 인프라 초기 투자** - game-renderer 테스트 지연이 개발 속도 저하
3. **Public API 설계 중요** - @ts-expect-error는 API 부족 신호
4. **TDD가 설계를 이끈다** - BFS 알고리즘 47개 테스트로 안정성 확보
5. **아키텍처 경계 고수** - game-core 순수성이 서버 재사용 기반 제공

---

## 기술 부채

| # | 항목 | 우선순위 | 출처 | 비고 |
|---|------|---------|------|------|
| 1 | Playwright E2E 테스트 미작성 | HIGH | Epic 1, 2, 3 | Epic 4 완료 전 필수 도입 |
| 2 | Triangle 객체 풀링 (BoardRenderer) | MEDIUM | Story 3-5 코드 리뷰 | hit test 성능 최적화 |
| 3 | TILE_META 조회 최적화 | MEDIUM | Story 3-5 코드 리뷰 | Map 캐시 또는 인덱스 접근 |
| 4 | 모바일 감지 로직 개선 | LOW | Story 3-5 코드 리뷰 | 터치 입력 기반 감지 |
| 5 | RENDER_DEPTH 상수 중앙화 | LOW | Story 3-5 코드 리뷰 | 매직 넘버 제거 |

---

## 액션 아이템

### 프로세스 개선

| # | 액션 아이템 | 담당 | 마감 | 성공 기준 |
|---|------------|------|------|----------|
| 1 | E2E 테스트 프레임워크 도입 (Playwright) | Dana (QA) | Epic 4 완료 전 | 이동 시스템 E2E 테스트 1개 이상 |
| 2 | Triangle 객체 풀링 구현 | Charlie (Dev) | Epic 5 시작 전 | getTileAtPosition() 성능 개선 |
| 3 | RENDER_DEPTH 상수 모듈 생성 | Elena (Dev) | Epic 4 중 | 모든 렌더러 depth 일관성 |

### 팀 합의 (계속 유지)

- [x] game-core에 Phaser 의존성 절대 금지 (계속 준수)
- [x] 새 상수/타입은 game-core에 먼저 정의
- [x] 스토리 완료 시 Dev Notes에 학습 내용 기록
- [x] 코드 리뷰에서 아키텍처 경계 확인
- [x] Result<T> 패턴으로 에러 처리 통일

### 새로운 팀 합의

- [x] Public getter로 데이터 노출 (private 접근 금지)
- [x] 게임 루프 내 new 사용 금지 (객체 재사용)

---

## Epic 2 회고 액션 아이템 추적

| # | 액션 아이템 | 담당 | 상태 | 비고 |
|---|------------|------|------|------|
| 1 | E2E 테스트 프레임워크 도입 (Playwright) | Dana (QA) | ⏳ 진행 중 | 아직 미완료, Epic 4로 이연 |
| 2 | TailwindCSS Portal 이슈 조사 | Elena (Dev) | ⏳ 진행 중 | 현재 inline style로 우회 중 |

**Epic 2 팀 합의 준수 여부:**
- ✅ game-core Phaser 금지: 완전 준수 (5/5 스토리)
- ✅ 새 상수/타입 game-core 정의: 준수 (MOVABLE_TILE, ActionType, MOVEMENT_ANIMATION)
- ✅ Dev Notes 기록: 준수 (5개 스토리 모두)
- ✅ 코드 리뷰 아키텍처 확인: 준수 (Story 3-5 코드 리뷰)

---

## Epic 4 준비 태스크

### 의존성 확인

| 의존성 | 상태 | 비고 |
|--------|------|------|
| 인접 타일 계산 | ✅ 완료 | getAdjacentTiles(), EDGE_ADJACENCY_MAP |
| 이동 시스템 | ✅ 완료 | moveGeneral(), 행동 시스템 |
| 애니메이션 시스템 | ✅ 완료 | animateMoveTo() 패턴 재사용 가능 |
| 타일 방향 정보 | ✅ 완료 | TileMeta.direction (up/down) |
| 병력 표시 | ✅ 완료 | Epic 2 Story 2-5 |
| 경로 탐색 | ✅ 완료 | findPath() 함수 |

**결론:** Epic 4 시작을 위한 모든 의존성 충족됨.

### Epic 4 미리보기

| # | 스토리 | 의존성 |
|---|--------|--------|
| 4-1 | 인접 공격 | Epic 3 이동 시스템, 인접 타일 계산 |
| 4-2 | 공격 방향 판정 (해/달/전선) | 타일 방향 시스템 |
| 4-3 | 방향별 피해 계산 | 장수 스탯 (sun, moon) |
| 4-4 | 병력 감소 | 장수 troops 관리 |
| 4-5 | 장수 OUT 처리 | 상태 관리 |
| 4-6 | 전투 피드백 | 애니메이션 시스템 |

---

## 중요 발견 사항

**에픽 업데이트 필요:** 아니오

Epic 3에서 Epic 4 계획을 근본적으로 변경해야 할 발견은 없었습니다.
- 이동 시스템 정상 작동
- 인접 타일 계산 검증됨
- 애니메이션 패턴 재사용 가능

---

## 준비 상태 평가

| 항목 | 상태 | 비고 |
|------|------|------|
| 테스트 & 품질 | ✅ 완료 | 352개 단위 테스트 통과 |
| 빌드 | ✅ 완료 | pnpm build 성공 |
| 타입 체크 | ✅ 완료 | pnpm typecheck 성공 |
| 기술 건강 | ✅ 양호 | 아키텍처 경계 100% 준수 |
| 미해결 차단요소 | ✅ 없음 | |

---

## 다음 단계

1. **sprint-status.yaml 업데이트** (Epic 3 → done, retrospective → done)
2. **Epic 4: 전투 시스템 시작** (`create-story` 워크플로우 사용)
3. **E2E 테스트 프레임워크 도입** (Dana 담당, HIGH 우선순위)
4. **다음 스탠드업에서 액션 아이템 리뷰**

---

## 기술적 성과 하이라이트

### 새로운 패턴/시스템

| 패턴 | 설명 | 파일 |
|------|------|------|
| BFS 이동 범위 | 장수 speed 기반 도달 가능 타일 계산 | game-core/src/board/adjacency.ts |
| BFS 경로 탐색 | 최단 경로 찾기 | game-core/src/board/adjacency.ts |
| 행동 제한 시스템 | 턴당 행동 횟수 및 동일 장수 동일 행동 제한 | game-core/src/movement/actions.ts |
| 애니메이션 입력 차단 | 애니메이션 중 입력 무시 | game-renderer/src/scenes/GameScene.ts |
| 경로 미리보기 | 호버/롱프레스로 이동 경로 시각화 | game-renderer/src/rendering/BoardRenderer.ts |
| Public getter API | BoardRenderer 데이터 접근 | game-renderer/src/rendering/BoardRenderer.ts |

### 이벤트 시스템 확장

| 이벤트 | 페이로드 | 용도 |
|--------|----------|------|
| general:moved | { generalId, from, to, actionsRemaining } | 장수 이동 완료 시 |

### 타입 확장

| 타입 | 설명 | 파일 |
|------|------|------|
| ActionType | 'move' \| 'attack' \| 'tactic' | game-core/src/state/types.ts |
| PerformedAction | { generalId, actionType } | game-core/src/state/types.ts |
| MoveAnimationOptions | { duration?, ease?, onComplete?, skipAnimation? } | game-renderer/src/constants/animation.ts |

---

## 문서 정보

- **생성일:** 2026-02-04
- **다음 회고:** Epic 4 완료 후
- **Sprint Status 키:** epic-3-retrospective → done
